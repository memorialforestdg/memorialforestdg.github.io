---
import type {ImageMetadata} from 'astro'
import {getImage} from 'astro:assets'

/**
 * All this to load the correct urls so they can be used in CSS custom-properites on backgrounds. :S
 *
 * The style declrations are added manually at this time.
 * If you add an image to the `/src/images/flourishes` folder you must also manually add it to the style secetion below.
 *
 * @TODO What is the tree shaking story re the inline syles tag? Are un used props being removed?
 */

interface Props {
  classes?: Array<string>
}
// User defined classes
const {classes = []} = Astro.props

// Location of the flourish images
const images = import.meta.glob<{default: ImageMetadata}>(
  '/src/images/flourishes/*.{jpeg,jpg,JPG,png,gif,avif,webp}'
)

// Defaults
const opts = {
  quality: 80,
  decoding: 'async',
  loading: 'lazy',
  width: 150,
  height: 150
}

/**
 * Use Astro getImage to fenerates an new image from the given source and provided options.
 *
 * @param {ImageMetadata} img
 * @param {String: "jpeg" | "jpg" | "JPG" | "png" | "gif" | "avif" | "webp"} format
 * @param {Object} opts
 */
async function generateImage(img, format, opts) {
  const {decoding, loading, quality, width, height} = opts

  return await getImage({
    src: img(),
    width,
    height,
    decoding,
    loading,
    quality,
    format
  })
}

// Generate the images and prop strings
const cssProps = await Promise.all(
  Object.entries(images).map(async ([key, image]) => {
    const filename = key
      .split('/')
      .pop()
      ?.split('.')
      .slice(0, -1)
      .join('.')
      .toLocaleLowerCase()

    const avifImage = await generateImage(image, 'avif', opts)
    const webpImage = await generateImage(image, 'webp', opts)
    const pngImage = await generateImage(image, 'png', opts)

    // For browsers that can handel image-set.
    const imageSet = `
    --${filename}:
      -webkit-image-set(
        url(${avifImage.src}) type("image/avif"),
        url(${webpImage.src}) type("image/webp"),
        url(${pngImage.src}) type("image/png")
      ),
      image-set(
        url(${avifImage.src}) type("image/avif"),
        url(${webpImage.src}) type("image/webp"),
        url(${pngImage.src}) type("image/png")
      );`
    // For browsers that cannna handel image-set.
    //I found that Safari 17.5 has difficulty with the type declaration.
    const fallback = `
    --${filename}-fb: url(${pngImage.src});`

    return `${fallback} ${imageSet}`
  })
)
---

<!-- The custom properties will be available to all descendants. -->
<div class={`flourish ${classes.join(' ')}`} style={`${cssProps.join('\n')}`}>
  <slot />
</div>
<style>
  .flourish {
    position: relative;
    z-index: 0;
    background-color: transparent;
  }

  .flourish::before {
    position: absolute;
    z-index: -1;
    display: block;
    background-repeat: no-repeat;
    background-size: cover;
    transition: transform 0.5s ease-in-out;
    content: '';
    inset-block-start: 0.5em;
    inline-size: 100px;
    block-size: 100px;
    inset-inline-start: -4em;
  }

  /*
    The css custom props are generated on the fly by the Flourish component, but you have to manually assign them below to clases below.
    In some respects this is good, as you can finesse the position ect for each image.
  */

  /* stylelint-disable declaration-block-no-duplicate-properties */
  .--alder.flourish::before {
    background-image: var(--alder-fb);
    background-image: var(--alder);
    transform: rotate(-20deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--apple.flourish::before {
    background-image: var(--apple-fb);
    background-image: var(--apple);
    transform: rotate(70deg);
    opacity: 0.65;
    inset-block-start: -2em;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--aspen.flourish::before {
    background-image: var(--aspen-fb);
    background-image: var(--aspen);
    transform: rotate(20deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--beech.flourish::before {
    background-image: var(--beech-fb);
    background-image: var(--beech);
    transform: rotate(20deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--downybirch.flourish::before {
    background-image: var(--downybirch-fb);
    background-image: var(--downybirch);
    transform: rotate(20deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--englishoak.flourish::before {
    background-image: var(--englishoak-fb);
    background-image: var(--englishoak);
    transform: rotate(20deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--fieldmaple.flourish::before {
    background-image: var(--fieldmaple-fb);
    background-image: var(--fieldmaple);
    transform: rotate(90deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--greywillow.flourish::before {
    background-image: var(--greywillow-fb);
    background-image: var(--greywillow);
    inset-block-start: -2em;
    opacity: 0.75;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--hawthorn.flourish::before {
    background-image: var(--hawthorn-fb);
    background-image: var(--hawthorn);
    transform: rotate(-50deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--holly.flourish::before {
    background-image: var(--holly-fb);
    background-image: var(--holly);
    inset-block-start: -2em;
    opacity: 0.75;
    inset-inline-start: -5em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--horsechestnut.flourish::before {
    background-image: var(--horsechestnut-fb);
    background-image: var(--horsechestnut);
    transform: rotate(20deg);
    opacity: 0.75;
    inset-block-start: -2em;
    inset-inline-start: -4em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--rowan-berries.flourish::before {
    background-image: var(--rowan-berries-fb);
    background-image: var(--rowan-berries);
    transform: rotate(20deg);
    opacity: 0.75;
    inset-block-start: -2.3em;
    inset-inline-start: -3em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--rowan-leaves.flourish::before {
    background-image: var(--rowan-leaves-fb);
    background-image: var(--rowan-leaves);
    inset-block-start: -1.8em;
    opacity: 0.75;
    inset-inline-start: -3em;
    inline-size: 100px;
    block-size: 100px;
  }

  .--silverbirch.flourish::before {
    background-image: var(--silverbirch-fb);
    background-image: var(--silverbirch);
    transform: rotate(-20deg);
    opacity: 0.75;
    inset-block-start: -1.8em;
    inset-inline-start: -3em;
    inline-size: 100px;
    block-size: 100px;
  }
</style>
